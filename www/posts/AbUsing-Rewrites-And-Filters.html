<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
<meta http-equiv="content-type" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#393E45" />
<link rel="stylesheet" href="/styles/vendor/modern-normalize.css" />
<link rel="stylesheet" href="/styles/vendor/github-markdown.css" />
<link rel="stylesheet" href="/styles/main.css" id="theme" />
<link rel="apple-touch-icon" sizes="57x57" href="//cdn.hampton.pw/favicons/apple-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="60x60" href="//cdn.hampton.pw/favicons/apple-icon-60x60.png" />
<link rel="apple-touch-icon" sizes="72x72" href="//cdn.hampton.pw/favicons/apple-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="//cdn.hampton.pw/favicons/apple-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="//cdn.hampton.pw/favicons/apple-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="//cdn.hampton.pw/favicons/apple-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="//cdn.hampton.pw/favicons/apple-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="//cdn.hampton.pw/favicons/apple-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="//cdn.hampton.pw/favicons/apple-icon-180x180.png" />
<link rel="icon" type="image/png" sizes="192x192" href="//cdn.hampton.pw/favicons/android-icon-192x192.png" />
<link rel="icon" type="image/png" sizes="32x32" href="//cdn.hampton.pw/favicons/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="96x96" href="//cdn.hampton.pw/favicons/favicon-96x96.png" />
<link rel="icon" type="image/png" sizes="16x16" href="//cdn.hampton.pw/favicons/favicon-16x16.png" />
<link rel="manifest" href="//cdn.hampton.pw/favicons/manifest.json" />
<meta name="msapplication-TileColor" content="#ffffff" />
<meta name="msapplication-TileImage" content="//cdn.hampton.pw/favicons/ms-icon-144x144.png" />
<meta name="theme-color" content="#ffffff" />
<img src="https://a.hampton.pw/funnyCatPhoto.gif" style="position:absolute; top:0; left:0" />
<script src="/scripts/global.js"></script>

		<title>(Ab)Using Caddy Rewrites and Filters</title>
		<meta property="og:title" content="(Ab)Using Caddy Rewrites and Filters" />
		<meta name="author" content="Hampton Moore" />
		<meta property="og:locale" content="en_US" />
		<meta name="description" content="Using Caddy to theme websites based on domain and cookies" />
		<link rel="stylesheet" href="/styles/vendor/prism.css" />
	</head>

	<body>
		<div class="main">
			<nav class="clearfix" role="navigation">
	<div class="container">
		<a class="logo" href="/"><img src="/img/logo.png" />Hampton Moore</a>
		<ul>
			<li><a href="/">Home</a></li>
			<li><a href="/projects">Projects</a></li>
			<li><a href="https://github.com/herohamp">Github</a></li>
			<li><a href="https://twitter.com/herohamp_">Twitter</a></li>
		</ul>
	</div>
</nav>

			<div class="markdown-body container text-container text-container-center pad-nav">
				<h1>(Ab)Using Caddy Rewrites and Filters</h1><h3>Why is Caddy?</h3><p>Caddy, is in my opinion one of the best if not the best web-server for plug and play hosting. The configuration files are simple and intuitive to use, with most site deploys being less than 7 lines. Caddy also includes auto SSL using Let&#39;s Encrypt. This makes Caddy a perfect fit for my ideal stack, a perfect stack just works and lets me easily deploy sites in less than a minute.</p>
<h3>Theming My Website Using Caddy Rewrites</h3><h4>THE RECENT CADDY UPDATE TO 1.0.0 HAS BROKEN FILTER, SO I NO LONGER USE THIS, THEME IS NOW CHOSEN BASED ON THE EPOCH AND RUN USING CSS VARIABLES</h4>

<p>Recently I have wanted to add theming to my website and decided I should finally get around to doing it. When I started looking at the different ways I could do it, nothing was of my liking. I took a look at both changing CSS Variables and switching out the href in link tags, but I did not want the theme be applied after the website first loading, causing a weird flicker between themes. Then I had the idea of having the server send different CSS files to the user based on a cookie. After a quick glance at the Caddy docs, I saw how easy this would be to implement. For each theme I just need a block of Caddy configuration code like this.</p>
<pre><code class="language-text">rewrite {
    if_op and
    if {~color} is purple
    if {file} is main.css
    to /styles/purple.css
}</code></pre>
<p>All this does is check the cookie, color, to see if it is &quot;purple&quot; and if the current file being accessed is main.css if so it rewrites to purple.css. This means that the client gets the theme that they have selected, without having to use Javascript to change CSS Variables, or href tags. Since I use SASS to create all of my CSS files generating each of these CSS files is a simple task.</p>
<h3>Changing The Cookie</h3><p>Since the theming is done based on cookies I needed a way to control cookies and change them. For this I wrote a short javascript snippet. Which just detects the users current theme, so that themes can be cycled through, then adds on event listener for my changeTheme button, which just cycles to the next theme and reloads the page.</p>
<pre><code class="language-javascript">var themes = [&quot;&quot;, &quot;purple&quot;, &quot;light&quot;];
var colorIndex = themes.indexOf(
    (&quot;; &quot; + document.cookie)
        .split(&quot;; color=&quot;)
        .pop()
        .split(&quot;;&quot;)
        .shift()
);

document.getElementById(&quot;changeTheme&quot;).addEventListener(&quot;click&quot;, function() {
    colorIndex++;
    colorIndex = colorIndex % themes.length;
    var e = new Date();
    e.setDate(e.getDate() + 365);
    document.cookie = &quot;color=&quot; + themes[colorIndex] + &quot;;expires=&quot; + e.toUTCString() + &quot;;path=/;&quot;;
    document.location.reload(true);
});</code></pre>
<h3>Caching</h3><p>There was one issue with this <em>perfect</em> solution, browsers were caching the CSS file meaning that even after the cookie was changed nothing changed as they never pinged my server. To fix this I simply had Caddy send do not cache headers on the theming CSS files. Caddy&#39;s rewrite system is run before headers are applied which is why it tells the user not to cache ANY css file in /styles/. This then meant vendor files were not being cached so I enabled caching for vendor files, by setting cache-control to a blank string.</p>
<pre><code class="language-text">header /styles/ Cache-Control &quot;no-cache, no-store, must-revalidate&quot;
header /styles/vendor Cache-Control &quot;&quot;</code></pre>
<h3>Maintaining Two Websites With The Time Of One</h3><p>Recently a friend of mine got the domain <a href="https://is-dummy-thi.cc">https://is-dummy-thi.cc</a>. He offered me a subdomain, from ther <a href="https://hampton.is-dummy-thi.cc">https://hampton.is-dummy-thi.cc</a> was born. I wanted it to be a rethemed version of my site, but as stated when I was talking about my perfect stack I like for things to be easy to deploy and just work and managing two versions of my site just for a meme would not have been fun. Looking at the Caddy rewrites I had discovered before I was easily able to retheme the site using a even less Caddy code.</p>
<pre><code class="language-text">rewrite /styles/main.css /styles/dummythicc.css</code></pre>
<p>but this meant my site still had the &quot;Change Theme&quot; button which had to go as I only wanted it to have one theme, this is when I discovered Caddy filters. These let me on the fly edit any pages on my website as they were being sent to the viewer. I setup a filter for the UI element for Changing Theme and just replaced it with a blank string. After that I switched out all instances of Hampton Moore, with &quot;Mr Hampton Dummy Thicc&quot;. This meant I could now run the joke website, without the hassle of maintaining two different websites</p>
<pre><code class="language-text">filter rule {
    content_type text/html.*
    search_pattern &quot;&lt;li&gt;&lt;a href=\&quot;#\&quot; id=\&quot;changeTheme\&quot;&gt;Change Theme&lt;/a&gt;&lt;/li&gt;&quot;
    replacement &quot;&quot;
}

filter rule {
    content_type text/html.*
    search_pattern &quot;Hampton Moore&quot;
    replacement &quot;Mr. Hampton Dummy Thicc&quot;
}</code></pre>
				<a href="/" class="return">Back to all posts</a>
				<script src="https://utteranc.es/client.js" repo="herohamp/herohamp.github.io" issue-term="title" theme="github-light" crossorigin="anonymous" async></script>
			</div>
			<div class="pad-footer"></div>
			<footer>
	<div class="container">
		<p>
			Â©
			<script type="text/javascript">
				document.write(new Date().getFullYear());
			</script>
			Hampton Moore || <a href="/feed.xml">RSS</a> || <a href="#" id="toggleDark">Toggle Darkmode</a>
		</p>
	</div>
</footer>

			<script src="/scripts/prism.js"></script>
		</div>
	</body>
</html>
